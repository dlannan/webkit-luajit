
<script>

function GetTransmittance( lightDir, lightExtinction )
{
	var y = lightDir.y;
	
	return new THREE.Vector3(
		Math.max(1 - Math.exp(y * lightExtinction.x), 0),
		Math.max(1 - Math.exp(y * lightExtinction.y), 0),
		Math.max(1 - Math.exp(y * lightExtinction.z), 0)
	);
}


function renderOceanSpecial( scene, renderer, camera ) {

    // render scene into target
    var gridvis = gridhelper.visible;
    var oceanvis = ocean.surface.visible;
    
    gridhelper.visible = false;
    ocean.surface.visible = false;

    renderer.setRenderTarget( ocean.surface.baseRender );
    renderer.render( scene, camera );
    
    gridhelper.visible = gridvis;
    ocean.surface.visible = oceanvis;
}

function setupScene(effectController) {

    var uniforms = sky.material.uniforms;
    if(earth) {
    uniforms.turbidity.value = effectController.turbidity;
    uniforms.rayleigh.value = effectController.rayleigh;
    uniforms.luminance.value = effectController.luminance;
    uniforms.mieCoefficient.value = effectController.mieCoefficient;
    uniforms.mieDirectionalG.value = effectController.mieDirectionalG;
    }
    
    sunSphere.visible = effectController.sun;
    skyUpdate(effectController);
    //renderer.render( scene, camera );
}

function skyUpdate(effectController) {
    
    sky.position.copy( camera.position );
    var distance = camera.far - 50.0;
    var theta = effectController.inclination;
    var phi = effectController.azimuth;

    var sinphi = Math.sin( phi );
    var cosphi = Math.cos( phi );
    var sintheta = Math.sin( theta );
    var costheta = Math.cos( theta );

    sunSphere.position.x = distance * sinphi * costheta;
    sunSphere.position.y = -distance * cosphi ;
    sunSphere.position.z = distance * cosphi * sintheta;
    sky.material.uniforms.sunPosition.value.copy( sunSphere.position );

    var sunDir = new THREE.Vector3().copy( sunSphere.position ).normalize();
    var trans = GetTransmittance( -sunDir, new THREE.Vector3(0.6, 0.8, 1.0));
    var sunFade = clamp((0.1 + sunDir.y) * 10.0, 0.0, 1.0);
    var scatterFade = clamp((0.15 + sunDir.y) * 4.0, 0.0, 1.0); 

    if(ocean.surface != undefined) {

        ocean.surface.material.uniforms.sunPos.value = sunDir;
        ocean.surface.material.uniforms.sunColor.value = dirLight.color;
        ocean.surface.material.uniforms.time.value += simstate.deltat * 0.7;

		ocean.surface.material.uniforms.sunFade.value = sunFade;
		ocean.surface.material.uniforms.scatterFade.value = scatterFade;
        ocean.surface.material.uniforms.sunTransmittance.value = trans;
    }

    if(ocean.floor != undefined) {

        ocean.floor.material.uniforms.sunPos.value = sunDir;
        ocean.floor.material.uniforms.sunColor.value = dirLight.color;
        ocean.floor.material.uniforms.timer.value += simstate.deltat * 0.7;

		ocean.floor.material.uniforms.sunFade.value = sunFade;
		ocean.floor.material.uniforms.scatterFade.value = scatterFade;
        ocean.floor.material.uniforms.sunTransmittance.value = trans;
    }
    
    if(grass != undefined && grass.children.length > 0) {
        for (i = 0; i < grass.children.length; i++) {
            var child = grass.children[i];
            child.material.uniforms.lightPos.value = sunSphere.position;
		    child.material.uniforms.time.value += simstate.deltat;
        }
    }

    var camposx = 300.0 * sinphi * costheta;
    var camposy = -300.0 * cosphi ;
    var camposz = 300.0 * cosphi * sintheta;

    dirLight.position.set(camposx + camera.position.x, camposy, camposz + camera.position.z);
    dirLightTarget.position.set(  camera.position.x, 0.0, camera.position.z);
    dirLight.target = dirLightTarget;

    var height = -cosphi;
    if(height < 0.001) height = 0.0;

    var cloudCover = (Math.sin(parameters.coverage * Math.PI * 0.5) * 0.6 + 0.4);
    var DiffuseIntensity = height * DiffuseLightScale * cloudCover;

    {# var newColor = (new THREE.Color( height, height, height ));
    dirLight.color = newColor; #}
    dirLight.intensity = (DiffuseIntensity + cloudCover) * 0.5 + 0.2;
    if(ambientLight) { 
        ambientLight.intensity = 0.2 * DiffuseIntensity + 0.05; 
    }
    
    renderer.toneMappingExposure = DiffuseIntensity * 1.0 + 0.4 ;
}

function initSky( ) {

    // Add Sky
    if(earth) {
        sky = new THREE.Sky( );
    } else {
        sky = new THREE.MoonSky();
    }
    sky.scale.setScalar( camera.far - 200.0 );
    env.add( sky );

    // Add Sun Helper
    sunSphere = new THREE.Mesh(
        new THREE.SphereBufferGeometry( 200, 16, 8 ),
        new THREE.MeshBasicMaterial( { color: new THREE.Color(0xffffff) } )
    );
    sunSphere.position.y = -(camera.far - 100.0);
    sunSphere.visible = false;
    env.add( sunSphere );

    /// GUI
    var effectController  = {
        turbidity: 10,
        rayleigh: 2,
        mieCoefficient: 0.005,
        mieDirectionalG: 0.8,
        luminance: 1,
        inclination: 0.5, // elevation / inclination
        azimuth: 0.0, // Facing front,
        sun: ! true
    };

    dirLight = new THREE.DirectionalLight( 0xffffff, 1.0 );
    dirLight.position.set(100, 100, 100);

    dirLight.castShadow = true;
//    dirLight.shadowCameraVisible = true;
//    dirLightShadow = new THREE.CameraHelper( camera );
    dirLight.shadow.mapSize.width = 4096;
    dirLight.shadow.mapSize.height = 4096;

    dirLight.position.multiplyScalar( 10 );
    var d = 120;

    dirLight.shadow.camera.left = -d;
    dirLight.shadow.camera.right = d;
    dirLight.shadow.camera.top = d;
    dirLight.shadow.camera.bottom = -d;

	dirLight.shadow.camera.near = 100;
	dirLight.shadow.camera.far = 500;

    dirLightTarget = new THREE.Object3D();
    dirLightTarget.position.set(0,0,0);
    env.add(dirLightTarget);

    env.add( dirLight );
    setupScene(effectController);
                    
    ambientLight = new THREE.HemisphereLight( 0xb1e1ff, 0xb97a20, 0.1); // soft white light
    env.add( ambientLight );

    checkSimpleEnvMap();
}

function skyParams( newval ) {
    var date = new Date();
    var min = Math.floor((newval.value % 1).toFixed(4) * 60.0);
    var hrs = Math.floor(newval.value);
    date.setHours(hrs, min, 0, 0);

    // get position of the sun (azimuth and altitude) at today's sunrise
    var sunrisePos = SunCalc.getPosition(date, -34.92, 138.6);
    //var sunrisePos = SunCalc.getPosition(date, 43.73, 138.6);

    parameters.inclination = sunrisePos.altitude;
    parameters.azimuth = sunrisePos.azimuth;
}

</script>