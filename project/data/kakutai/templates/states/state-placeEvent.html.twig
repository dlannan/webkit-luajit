
function checkEventPlacement( ) {

    var ok = (mode.state === EditorMode.EVENTNEW) || 
                (mode.state === EditorMode.EVENTPLACE);
    if(!ok) return;

    var intersections = checkHit();

    if ( intersections.length > 0 ) {

        // check object isnt the one we are dragging around!!
        for( var i=0; i<intersections.length; i++ ) {
            var test = intersections[ i ].object;
            if( test.userData.parentId != mode.object.userData.uid )
                break;
        }

        //placeEventState.parent = intersections[ i ].object.parent.parent;
        selectCursor.position.copy( intersections[ i ].point );

        var n = intersections[ i ].normal;
        var d = camera.position.distanceTo( intersections[ i ].point );
        
        selectCursor.scale.set( d, d, d );
        //selectCursor.lookAt( intersections[ i ].point + n );

        if(mode.object) {

            var pt = intersections[ i ].point;
        	mode.object.position.copy( pt );
            SceneGraph.updateEntityPosition( mode.object.userData.uid, pt.x, pt.y, pt.z );            
        	//mode.object.lookAt( intersections[ i ].point + n );
            SceneGraph.forceUpdate( mode.object.userData.uid );        
            SceneGraph.forceRender( mode.object.userData.uid );        
        }
    }
    else {

        var line = new THREE.Line3(camera.position, camera.position + cameraDir * 5000.0);
        var target = new THREE.Vector3();
        var pt = allcameras.persp.worldPlane.intersectLine(line, target);
        var d = pt.distanceTo(camera.position);
        
        selectCursor.position.copy(pt);
        //selectCursor.scale.set( d, d, d );
        //selectCursor.lookAt( pt + worldUp );

        //placeEventState.parent = null;
    }
}

var placeEventState = {

    name: "placeEvent",
    value: 0,              // Set this value to react to external state control
    parent: undefined,      // If this is set, exit ensures the parent state is reactivated

    onenter: function(init) {

        selectCursor.material.color.setHex(0xff0000);
        selectCursor.visible = true;
        disableControls();
        hidePopups();
        console.log("Initializing Event..");
    },

    onupdate: function(dt) {

        // Dont do much - its an init state, nothing to see here.
        checkEventPlacement();
    },

    onmouse: function( event ) {

        if(event.type === "mouseup") {

            FinishEventPlacement();
            mode.state = EditorMode.NONE;
            mode.popup = PopupMode.MAIN;
        }
    },

    onexit: function() {

    }
};