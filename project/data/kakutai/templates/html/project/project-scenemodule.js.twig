<script>
var sceneidSelected = -1;
var scenedata = {};
{% for key, scene in scenedb %}
{% if scene %} 
  scenedata[ "{{ key }}" ] = {
    sceneid:  "{{ scene.sceneid }}", 
    models: "{{ scene.models }}"
  };
{% endif %}
{% endfor %}

$(document).ready(function() {

  $('#select-scene-module').on('change', function (e) {
    var optionSelected = $("option:selected", this);
    var valueSelected = this.value;
//console.log(valueSelected);

    var html = "";
    var datalist = scenedata[valueSelected];
    sceneidSelected = datalist.sceneid;

    if( datalist.models.length > 0 ) {
      $('#select-module').val(datalist.models);
    } else {
      $('#select-module').val(0);
    }

    {# for (let key of Object.keys(datalist)) {  
      let value = datalist[key];   
      
      if( key !== "data") {
      var data = "{% include 'macros/project-scenedata-keyvalue.html.twig' %}";
        data = data.replace(/datatable_key/g, key);  
        data = data.replace(/datatable_value/g, value);  
        data = data.replace(/datatable_sceneid/g, datalist.sceneid);  
        html += data;
      }
    }
    if(html === "") {
      html = "{% include 'macros/project-scenedata-error.html.twig' %}";
    }
    html = html.replace(/;/g, "");

    $('#scene-data-table').html(html); #}
  });

  $('#select-module').on('change', function (e) {
    var optionSelected = $("option:selected", this);
    var valueSelected = this.value;

    if(valueSelected === '0') { valueSelected = ""; }

    var url = "{{ page.url }}";
    var params = "{{ uri.query }}&sceneid=" + sceneidSelected + "&models=" + valueSelected;

    var http = new XMLHttpRequest();
    http.open("POST", url, true);

    // Write this to the DB if possible. Ideally a simple submit would be great!
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    http.setRequestHeader("Content-length", params.length);
    http.setRequestHeader("Connection", "close");

    http.onreadystatechange = function() {//Call a function when the state changes.
      if(http.readyState == 4 && http.status == 200) {
        //$('#error_output').html(http.responseText);
        console.log(http.responseText);
      }
    }
    http.send(params);

  });

});
</script>
